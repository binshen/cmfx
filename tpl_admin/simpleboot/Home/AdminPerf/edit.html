<admintpl file="header" /><link href="__ROOT__/statics/js/jquery-ui/jquery-ui.min.css" rel="stylesheet"><script src="__ROOT__/statics/js/jquery-ui/jquery-ui.min.js"></script><script src="__ROOT__/statics/js/layer/layer.js"></script>  <style>  .custom-combobox {    position: relative;    display: inline-block;  }  .custom-combobox-toggle {    position: absolute;    top: 0;    bottom: 0;    margin-left: -1px;    padding: 0;  }  .custom-combobox-input {    margin: 0;    padding: 5px 10px;  }  </style>  <script>  (function( $ ) {    $.widget( "custom.combobox", {      _create: function() {        this.wrapper = $( "<span>" )          .addClass( "custom-combobox" )          .insertAfter( this.element );         this.element.hide();        this._createAutocomplete();        this._createShowAllButton();      },       _createAutocomplete: function() {        var selected = this.element.children( ":selected" ),          value = selected.val() ? selected.text() : "";         this.input = $( "<input>" )          .appendTo( this.wrapper )          .val( value )          .attr( "title", "" )          .addClass( "custom-combobox-input ui-widget ui-widget-content ui-state-default ui-corner-left" )          .autocomplete({            delay: 0,            minLength: 0,            source: $.proxy( this, "_source" )          })          .tooltip({            tooltipClass: "ui-state-highlight"          });         this._on( this.input, {          autocompleteselect: function( event, ui ) {            ui.item.option.selected = true;            this._trigger( "select", event, {              item: ui.item.option            });          },           autocompletechange: "_removeIfInvalid"        });      },       _createShowAllButton: function() {        var input = this.input,          wasOpen = false;         $( "<a>" )          .attr( "tabIndex", -1 )          //.attr( "title", "显示所有可选项" )          //.tooltip()          .appendTo( this.wrapper )          .button({            icons: {              primary: "ui-icon-triangle-1-s"            },            text: false          })          .removeClass( "ui-corner-all" )          .addClass( "custom-combobox-toggle ui-corner-right" )          .mousedown(function() {            wasOpen = input.autocomplete( "widget" ).is( ":visible" );          })          .click(function() {            input.focus();             // Close if already visible            if ( wasOpen ) {              return;            }             // Pass empty string as value to search for, displaying all results            input.autocomplete( "search", "" );          });      },       _source: function( request, response ) {        var matcher = new RegExp( $.ui.autocomplete.escapeRegex(request.term), "i" );        response( this.element.children( "option" ).map(function() {          var text = $( this ).text();          if ( this.value && ( !request.term || matcher.test(text) ) )            return {              label: text,              value: text,              option: this            };        }) );      },       _removeIfInvalid: function( event, ui ) {         // Selected an item, nothing to do        if ( ui.item ) {          return;        }         // Search for a match (case-insensitive)        var value = this.input.val(),          valueLowerCase = value.toLowerCase(),          valid = false;        this.element.children( "option" ).each(function() {          if ( $( this ).text().toLowerCase() === valueLowerCase ) {            this.selected = valid = true;            return false;          }        });         // Found a match, nothing to do        if ( valid ) {          return;        }         // Remove invalid value        this.input          .val( "" )          //.attr( "title", value + ": 输入的内容不存在" )          .attr( "title", "输入的内容不存在" )          .tooltip( "open" );        this.element.val( "" );        this._delay(function() {          this.input.tooltip( "close" ).attr( "title", "" );        }, 2500 );        this.input.autocomplete( "instance" ).term = "";      },       _destroy: function() {        this.wrapper.remove();        this.element.show();      }    });  })( jQuery );   $(function() {    $( "#projectSelect" ).combobox();    $( "#brokerSelect" ).combobox({    	select: function( event, ui ) {    		var agency = $("#agency").val();    		if(agency == "") {    			layer.msg('请先输入中介费', { time: 2000 });    			$("#brokerSelect").val("");    			ui.item.val("");    			return;    		}    		calculateBrokerPerf();    	}    });  });  </script><body class="J_scroll_fixed"><div class="wrap J_check_wrap" style="width:450px; height:360px;">  	<form class="J_ajaxForm" action="{:U('AdminPerf/edit_post')}" method="post">      	<div class="table_list">      		<input type="hidden" name="id" value="{$id}">      		<input type="hidden" name="rank_id" id="broker_rank_id" value="{$rank_id}">			<table cellpadding="0" cellspacing="0" class="table_form">				<tbody>					<tr>						<td style="width:80px;">房产类型:</td>						<td colspan="3">							<select name="tid" id="typeSelect">								<volist name="typeList" id="vo">									<php>$selected=$vo['id']===$tid?"selected":"";</php>									<option value="{$vo.id}" {$selected}>{$vo.name}</option>								</volist>							</select>						</td>					</tr>					<tr>						<td>楼盘:</td>						<td colspan="3">							<select name="pid" id="projectSelect">								<option value="">- 选择 -</option>								<volist name="projectList" id="vo">									<php>$selected=$vo['id']===$pid?"selected":"";</php>									<option value="{$vo.id}" {$selected}>{$vo.name}</option>								</volist>							</select>						</td>					</tr>					<tr>						<td>日期:</td>						<td style="padding-top:8px;">							<input type="text" class="input J_date" name="date" id="date" style="width:100px;" maxlength="6" value="{$date|default=date('Y-m-d')}">						</td>						<td style="width:100px; padding-right:8px;" align="right">楼盘成交价:</td>						<td style="padding-top:8px;">							<input type="text" class="input" name="total" id="total" style="width:80px;" value="{$total}">元						</td>					</tr>					<tr>						<td>房号:</td>						<td colspan="3">							<input type="text" class="input" name="num" id="num" style="width:330px;" value="{$num}">						</td>					</tr>					<tr>						<td>中介费:</td>						<td><input type="text" class="input" name="agency" id="agency" style="width:100px;" value="{$agency}">元</td>						<td style="width:100px;" align="right">评估费:&nbsp;&nbsp;</td>						<td><input type="text" class="input" name="estimate" id="estimate" style="width:100px;" value="{$estimate|default=0}">元</td>					</tr>					<tr>						<td>贷款服务费: </td>						<td><input type="text" class="input" name="service" id="service" style="width:100px;" value="{$service|default=0}">元</td>						<td align="right">其他费用:&nbsp;&nbsp;</td>						<td><input type="text" class="input" name="others" id="others" style="width:100px;" value="{$others|default=0}">元</td>					</tr>					<tr>						<td>业务员:</td>						<td colspan="3">							<select name="bid" id="brokerSelect">								<option value="">- 选择 -</option>								<volist name="brokerList" id="vo">									<php>$selected=$vo['id']===$bid?"selected":"";</php>									<option value="{$vo.id}" {$selected}>{$vo.name}</option>								</volist>							</select>						</td>					</tr>					<tr>						<td>佣金:</td>						<td style="padding-top:8px;"><input type="text" class="input" name="bkg" id="broker_perf" style="width:100px;" value="{$bkg}">元</td>						<td style="width:100px;" align="right">级别:</td>						<td><span id="broker_rank">{$rank_name}</span></td>					</tr>					<tr>						<td>备注:</td>						<td colspan="3">							<textarea style="width:330px" name="comment" id="comment">{$comment}</textarea>						</td>					</tr>				</tbody>			</table>		</div>		<div class="pop_bottom">			<button class="btn fr" id="J_dialog_close" type="button">取消</button>			<button type="submit" class="btn btn-primary J_ajax_submit_btn">保存</button>		</div>  	</form></div><script src="__ROOT__/statics/js/common.js"></script><script>$(function() {		$("#typeSelect").change(function() {		calculateBrokerPerf();	});		$("#agency").blur(function() {		calculateBrokerPerf();	});		$("#estimate").blur(function() {		calculateBrokerPerf();	});			$("#service").blur(function() {		calculateBrokerPerf();	});		$("#others").blur(function() {		calculateBrokerPerf();	});});function calculateBrokerPerf() {	var agency = $("#agency").val() || 0;	var estimate = $("#estimate").val() || 0;	var service = $("#service").val() || 0;	var others = $("#others").val() || 0;	var perf = parseFloat(agency) + parseFloat(estimate) + parseFloat(service) + parseFloat(others);	var bid = $("#brokerSelect").val();	if(bid > 0) {		$.post('/Home/AdminPerf/get_calculated_perf', {			id: bid, 			date: $("#date").val(),			total: parseFloat(perf),			tid: $("#typeSelect").val()		}, function(data) {			var data = JSON.parse(data);			$("#broker_rank").text(data.rank);			$("#broker_perf").val(data.bkg);			$("#broker_rank_id").val(data.rank_id);		});	}}</script></body>