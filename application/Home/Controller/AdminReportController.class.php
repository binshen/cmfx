<?phpnamespace Home\Controller;use Common\Controller\AdminbaseController;class AdminReportController extends AdminbaseController {        protected $Dao;    private $month = array(1 => "03", 2 => "06", 3 => "09", 4 => "12");        function _initialize() {                parent::_initialize();        $this->Dao = D("Home/Perf");                vendor('PHPExcel.PHPExcel');                $yearList = array();        for($i=0; $i<10; $i++) {            $yearList[] = date("Y",strtotime("-$i year"));        }        $this->assign('yearList', $yearList);    }        function index() {        $this->display();    }        function report() {            $this->display();    }        private function getPaid($type, $year, $month = NULL) {                $sql = " SELECT bid, date, SUM(pay) AS pay FROM sd_pay_log WHERE type = $type AND SUBSTRING(date, 1, 4) = '$year' ";        if(!empty($month)) $sql = " AND SUBSTRING(date, 5, 2) = '$month' ";        $sql .= " GROUP BY bid, date";        return $this->Dao->query($sql);    }        function download() {                extract($_POST);                $sql = "            SELECT            	sd_perf.date,            	sd_project.name AS p_name,            	sd_perf.num,            	sd_perf.total,            	sd_broker.name AS b_name,            	sd_store.name AS s_name,            	sd_rank.name AS r_name,            	sd_perf.perf,            	sd_perf.bkg AS m_perf,            	sd_perf.payd AS m_payd,            	sd_perf.q_perf,            	sd_perf.q_payd,            	sd_perf.y_perf,            	sd_perf.y_payd,            	sd_perf.comment,                sd_rank.id AS r_id,                sd_broker.id AS b_id,                sd_broker.date AS b_date            FROM sd_perf            LEFT JOIN sd_broker ON sd_broker.id = sd_perf.bid            LEFT JOIN sd_project ON sd_project.id = sd_perf.pid            LEFT JOIN sd_rank ON sd_rank.id = sd_broker.rank_id            LEFT JOIN sd_store ON sd_store.manager_id = sd_broker.parent_id            WHERE YEAR(sd_perf.date) = {$year}        ";                $suffix = $year;        if($style == 2) {            $sql .= " AND QUARTER(sd_perf.date) = {$quarter} ";            $suffix .= "-{$quarter}季度";        } else if($style == 3) {            $sql .= " AND MONTH(sd_perf.date) = {$month} ";            $suffix .= "-{$month}月份";        }                $sql .= " ORDER BY sd_perf.date ASC ";        $data = $this->Dao->query($sql);            $MPerf = array();        $QPerf = array();        $YPerf = array();        $m_data = $this->getPaid(1, $year);        foreach ($m_data as $d) {            $bid = $d['bid'];            $date = $d['date'];            if(empty($MPerf[$bid])) $MPerf[$bid] = array();            $MPerf[$bid][$date] = $d['pay'];        }                $q_data = $this->getPaid(3, $year);        foreach ($q_data as $d) {            $bid = $d['bid'];            $date = $d['date'];            if(empty($QPerf[$bid])) $QPerf[$bid] = array();            $QPerf[$bid][$date] = $d['pay'];        }                $y_data = $this->getPaid(4, $year);        foreach ($y_data as $d) {            $bid = $d['bid'];            $date = $d['date'];            if(empty($YPerf[$bid])) $YPerf[$bid] = array();            $YPerf[$bid][$date] = $d['pay'];        }                $reports = array();        $totalList = array();        $totalReport = array();        foreach ($data as $d) {            $date = $d['date'];            $year = date('Y', strtotime($date));            $quarter = ceil(date('m', strtotime($date)) / 3);            $month = date('m', strtotime($date));                        $b_date = $d['b_date'];            $bid = $d['b_id'];            $rank_id = $d['r_id'];            if($rank_id == 1) {                $b_year = date('Y', strtotime($b_date));                $b_month = date('m', strtotime($b_date));                $b_day = date('d', strtotime($b_date));                if($b_year == $year && $b_month == $month && $b_day <= 15) {                    $d['wage'] = 2000;                } else {                    $d['wage'] = 0;                }            } else {                $d['wage'] = 0;            }            $reports[$year.$month][] = $d;                        //月度合计            $totalReport[$year.$month]['wage']   += $d['wage'];            $totalReport[$year.$month]['perf']   += $d['perf'];            $totalReport[$year.$month]['m_perf'] += $d['m_perf'];            $totalReport[$year.$month]['q_perf'] += $d['q_perf'];            $totalReport[$year.$month]['y_perf'] += $d['y_perf'];                        //汇总表合计            $totalList[$bid]['b_name'] = $d['b_name'];            $totalList[$bid]['s_name'] = $d['s_name'];            $totalList[$bid]['r_name'] = $d['r_name'];                        $totalList[$bid]['wage']   += $d['wage'];            $totalList[$bid]['perf']   += $d['perf'];            $totalList[$bid]['m_perf'] += $d['m_perf'];            $totalList[$bid]['q_perf'] += $d['q_perf'];            $totalList[$bid]['y_perf'] += $d['y_perf'];                        $totalList[$bid]['m_payd'] += $d['m_payd'];//empty($MPerf[$bid][$year.$month])?0:$MPerf[$bid][$year.$month];            $totalList[$bid]['q_payd'] += empty($QPerf[$bid][$year.$month])?0:$QPerf[$bid][$year.$month];            $totalList[$bid]['y_payd'] += empty($YPerf[$bid][$year.$month])?0:$YPerf[$bid][$year.$month];        }                $objPHPExcel = new \PHPExcel();        $sheetIndex = 0;        foreach ($reports as $month => $rs) {            $objPHPExcel->createSheet($sheetIndex);            $objPHPExcel->setActiveSheetIndex($sheetIndex)                ->setCellValue('A1', '日期')                ->setCellValue('B1', '楼盘名称')                ->setCellValue('C1', '房号')                ->setCellValue('D1', '总价')                ->setCellValue('E1', '业务员')                ->setCellValue('F1', '店东')                ->setCellValue('G1', '级别')                ->setCellValue('H1', '工资')                ->setCellValue('I1', '业绩')                ->setCellValue('J1', '月度提成')                ->setCellValue('K1', '季度提成')                ->setCellValue('L1', '年度提成')                ->setCellValue('M1', '备注');                        foreach ($rs as $i => $d) {                $idx = $i + 2;                $objPHPExcel->setActiveSheetIndex($sheetIndex)                    ->setCellValue('A' . $idx, $d['date'])                    ->setCellValue('B' . $idx, $d['p_name'])                    ->setCellValueExplicit('C' . $idx, $d['num'], \PHPExcel_Cell_DataType::TYPE_STRING)                    ->setCellValue('D' . $idx, $d['total'])                    ->setCellValue('E' . $idx, $d['b_name'])                    ->setCellValue('F' . $idx, $d['s_name'])                    ->setCellValue('G' . $idx, $d['r_name'])                    ->setCellValue('H' . $idx, $d['wage'])                    ->setCellValue('I' . $idx, $d['perf'])                    ->setCellValue('J' . $idx, $d['m_perf'])                    ->setCellValue('K' . $idx, $d['q_perf'])                    ->setCellValue('L' . $idx, $d['y_perf'])                    ->setCellValueExplicit('M' . $idx, $d['comment'], \PHPExcel_Cell_DataType::TYPE_STRING);            }            $objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(10);            $objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(20);            $objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(15);            $objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(15);            $objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('G')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('H')->setWidth(10);            $objPHPExcel->getActiveSheet()->getColumnDimension('I')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('J')->setWidth(10);            $objPHPExcel->getActiveSheet()->getColumnDimension('K')->setWidth(10);            $objPHPExcel->getActiveSheet()->getColumnDimension('L')->setWidth(10);            $objPHPExcel->getActiveSheet()->getColumnDimension('M')->setWidth(20);            $objPHPExcel->getActiveSheet()->setTitle(strval($month));            $sheetIndex++;                        //合计            $idx++;            $objPHPExcel->getActiveSheet()->mergeCells('A' . $idx . ':G' . $idx)->setCellValue('A' . $idx, '合计');            $objPHPExcel->getActiveSheet()->getStyle('A' . $idx)->applyFromArray(array(                'alignment' => array('horizontal' => \PHPExcel_Style_Alignment::HORIZONTAL_CENTER)            ));            $objPHPExcel->getActiveSheet()->setCellValue('H' . $idx, $totalReport[$month]['wage']);            $objPHPExcel->getActiveSheet()->setCellValue('I' . $idx, $totalReport[$month]['perf']);            $objPHPExcel->getActiveSheet()->setCellValue('J' . $idx, $totalReport[$month]['m_perf']);            $objPHPExcel->getActiveSheet()->setCellValue('K' . $idx, $totalReport[$month]['q_perf']);            $objPHPExcel->getActiveSheet()->setCellValue('L' . $idx, $totalReport[$month]['y_perf']);        }                if(!empty($totalList)) {            $objPHPExcel->createSheet($sheetIndex);            $objPHPExcel->setActiveSheetIndex($sheetIndex)                ->setCellValue('A1', '业务员')                ->setCellValue('B1', '店东')                ->setCellValue('C1', '级别')                ->setCellValue('D1', '工资')                ->setCellValue('E1', '业绩')                ->setCellValue('F1', '月度提成')                ->setCellValue('G1', '季度提成')                ->setCellValue('H1', '年度提成')                ->setCellValue('I1', '月度已发')                ->setCellValue('J1', '季度已发')                ->setCellValue('K1', '年度已发')                ->setCellValue('L1', '剩余提成');                        $idx = 2;            $totalReport = array();            foreach ($totalList as $d) {                $surplus = $d['m_perf'] + $d['q_perf'] + $d['y_perf'] - $d['m_payd'] - $d['q_payd'] - $d['y_payd'];                $objPHPExcel->setActiveSheetIndex($sheetIndex)                    ->setCellValue('A' . $idx, $d['b_name'])                    ->setCellValue('B' . $idx, $d['s_name'])                    ->setCellValue('C' . $idx, $d['r_name'])                    ->setCellValue('D' . $idx, $d['wage'])                    ->setCellValue('E' . $idx, $d['perf'])                    ->setCellValue('F' . $idx, $d['m_perf'])                    ->setCellValue('G' . $idx, $d['q_perf'])                    ->setCellValue('H' . $idx, $d['y_perf'])                    ->setCellValue('I' . $idx, $d['m_payd'])                    ->setCellValue('J' . $idx, $d['q_payd'])                    ->setCellValue('K' . $idx, $d['y_payd'])                    ->setCellValue('L' . $idx, $surplus);                $idx++;                                $totalReport['wage'] += $d['wage'];                $totalReport['perf'] += $d['perf'];                $totalReport['m_perf'] += $d['m_perf'];                $totalReport['q_perf'] += $d['q_perf'];                $totalReport['y_perf'] += $d['y_perf'];                $totalReport['m_payd'] += $d['m_payd'];                $totalReport['q_payd'] += $d['q_payd'];                $totalReport['y_payd'] += $d['y_payd'];                $totalReport['surplus'] += $surplus;            }                        $objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(15);            $objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(15);            $objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(15);            $objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(15);            $objPHPExcel->getActiveSheet()->getColumnDimension('G')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('H')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('I')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('J')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('K')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('L')->setWidth(12);                        //合计            $objPHPExcel->getActiveSheet()->mergeCells('A' . $idx . ':C' . $idx)->setCellValue('A' . $idx, '合计');            $objPHPExcel->getActiveSheet()->getStyle('A' . $idx)->applyFromArray(array(                'alignment' => array('horizontal' => \PHPExcel_Style_Alignment::HORIZONTAL_CENTER)            ));            $objPHPExcel->getActiveSheet()->setCellValue('D' . $idx, $totalReport['wage']);            $objPHPExcel->getActiveSheet()->setCellValue('E' . $idx, $totalReport['perf']);            $objPHPExcel->getActiveSheet()->setCellValue('F' . $idx, $totalReport['m_perf']);            $objPHPExcel->getActiveSheet()->setCellValue('G' . $idx, $totalReport['q_perf']);            $objPHPExcel->getActiveSheet()->setCellValue('H' . $idx, $totalReport['y_perf']);            $objPHPExcel->getActiveSheet()->setCellValue('I' . $idx, $totalReport['m_payd']);            $objPHPExcel->getActiveSheet()->setCellValue('J' . $idx, $totalReport['q_payd']);            $objPHPExcel->getActiveSheet()->setCellValue('K' . $idx, $totalReport['y_payd']);            $objPHPExcel->getActiveSheet()->setCellValue('L' . $idx, $totalReport['surplus']);                        $objPHPExcel->getActiveSheet()->setTitle("业绩汇总");        }                $filename = "业务员提成明细表-" . $suffix;        $this->outputExcel($objPHPExcel, $filename);    }        function applyPerf() {                extract($_POST);                $sql = "            SELECT            sd_perf.date,            sd_project.name AS p_name,            sd_perf.num,            sd_perf.total,            sd_broker.name AS b_name,            sd_store.name AS s_name,            sd_rank.name AS r_name,            sd_perf.perf,            sd_perf.bkg AS m_perf,            sd_perf.comment,            sd_rank.id AS r_id,            sd_broker.id AS b_id,            sd_broker.date AS b_date            FROM sd_perf            LEFT JOIN sd_broker ON sd_broker.id = sd_perf.bid            LEFT JOIN sd_project ON sd_project.id = sd_perf.pid            LEFT JOIN sd_rank ON sd_rank.id = sd_broker.rank_id            LEFT JOIN sd_store ON sd_store.manager_id = sd_broker.parent_id            WHERE YEAR(sd_perf.date) = {$year}            AND MONTH(sd_perf.date) = {$month}        ";        $sql .= " ORDER BY sd_perf.date ASC ";        $data = $this->Dao->query($sql);                $reports = array();        $totalReport = array();        foreach ($data as $d) {            $date = $d['date'];            $year = date('Y', strtotime($date));            $month = date('m', strtotime($date));                        $b_date = $d['b_date'];            $rank_id = $d['r_id'];            if($rank_id == 1) {                $b_year = date('Y', strtotime($b_date));                $b_month = date('m', strtotime($b_date));                $b_day = date('d', strtotime($b_date));                if($b_year == $year && $b_month == $month && $b_day <= 15) {                    $d['wage'] = 2000;                } else {                    $d['wage'] = 0;                }            } else {                $d['wage'] = 0;            }            if($rank_id >= 3 && $rank_id <= 5) {                $d['q_perf'] = $d['perf'] * ($rank_id - 2) * 0.05;                $d['y_perf'] = $d['perf'] * 0.05;            } else {                $d['q_perf'] = 0;                $d['y_perf'] = 0;            }            $reports[$year.$month][] = $d;                        $totalReport[$year.$month]['m_perf'] += $d['m_perf'];            $totalReport[$year.$month]['q_perf'] += $d['q_perf'];            $totalReport[$year.$month]['y_perf'] += $d['y_perf'];        }                $objPHPExcel = new \PHPExcel();                $sheetIndex = 0;        foreach ($reports as $month => $rs) {            $objPHPExcel->createSheet($sheetIndex);            $objPHPExcel->setActiveSheetIndex($sheetIndex)                ->setCellValue('A1', '序号')                ->setCellValue('B1', '姓名')                ->setCellValue('C1', '楼盘名称')                ->setCellValue('D1', '房号')                ->setCellValue('E1', '日期')                ->setCellValue('F1', '级别')                ->setCellValue('G1', '工资')                ->setCellValue('H1', '业绩')                ->setCellValue('I1', '月度实发')                ->setCellValue('J1', '季度预留')                ->setCellValue('K1', '年度预留')                ->setCellValue('L1', '备注');                                foreach ($rs as $i => $d) {                $idx = $i + 2;                $objPHPExcel->setActiveSheetIndex($sheetIndex)                    ->setCellValue('A' . $idx, $i + 1)                    ->setCellValue('B' . $idx, $d['b_name'])                    ->setCellValue('C' . $idx, $d['p_name'])                    ->setCellValueExplicit('D' . $idx, $d['num'], \PHPExcel_Cell_DataType::TYPE_STRING)                    ->setCellValue('E' . $idx, $d['date'])                    ->setCellValue('F' . $idx, $d['r_name'])                    ->setCellValue('G' . $idx, $d['wage'])                    ->setCellValue('H' . $idx, $d['perf'])                    ->setCellValue('I' . $idx, $d['m_perf'])                    ->setCellValue('J' . $idx, $d['q_perf'])                    ->setCellValue('K' . $idx, $d['y_perf'])                    ->setCellValueExplicit('L' . $idx, $d['comment'], \PHPExcel_Cell_DataType::TYPE_STRING);            }            $objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(10);            $objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(15);            $objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(15);            $objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('G')->setWidth(8);            $objPHPExcel->getActiveSheet()->getColumnDimension('H')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('I')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('J')->setWidth(12);            $objPHPExcel->getActiveSheet()->getColumnDimension('K')->setWidth(10);            $objPHPExcel->getActiveSheet()->getColumnDimension('L')->setWidth(20);            $objPHPExcel->getActiveSheet()->setTitle(strval($month));            $sheetIndex++;                        $idx++;            $objPHPExcel->getActiveSheet()->mergeCells('A' . $idx . ':H' . $idx)->setCellValue('A' . $idx, '合计');            $objPHPExcel->getActiveSheet()->getStyle('A' . $idx)->applyFromArray(array(                'alignment' => array('horizontal' => \PHPExcel_Style_Alignment::HORIZONTAL_CENTER)
            ));            $objPHPExcel->getActiveSheet()->setCellValue('I' . $idx, $totalReport[$month]['m_perf']);            $objPHPExcel->getActiveSheet()->setCellValue('J' . $idx, $totalReport[$month]['q_perf']);            $objPHPExcel->getActiveSheet()->setCellValue('K' . $idx, $totalReport[$month]['y_perf']);        }                $filename = "顺达地产提成申请表";        $this->outputExcel($objPHPExcel, $filename);    }        private function outputExcel($objPHPExcel, $filename) {                // Set active sheet index to the first sheet, so Excel opens this as the first sheet        $objPHPExcel->setActiveSheetIndex(0);                // Redirect output to a client’s web browser (Excel5)        header('Content-Type: application/vnd.ms-excel');        header('Content-Disposition: attachment;filename=' . $filename);        header('Cache-Control: max-age=0');        // If you're serving to IE 9, then the following may be needed        header('Cache-Control: max-age=1');                // If you're serving to IE over SSL, then the following may be needed        header ('Expires: Mon, 26 Jul 1997 05:00:00 GMT'); // Date in the past        header ('Last-Modified: '.gmdate('D, d M Y H:i:s').' GMT'); // always modified        header ('Cache-Control: cache, must-revalidate'); // HTTP/1.1        header ('Pragma: public'); // HTTP/1.0                $objWriter = \PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');        $objWriter->save('php://output');    }}